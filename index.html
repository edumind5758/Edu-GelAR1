<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kuis Geleng Kepala - Peredaran Darah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      margin: 0; 
      font-family: 'Comic Sans MS', 'Arial', sans-serif; 
      background:#111; 
      color:#fff; 
      text-align:center;
      overflow: hidden;
      position: relative;
      height: 100vh;
    }
    
    /* Video disembunyikan sepenuhnya */
    video { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh; 
      object-fit: cover; 
      opacity: 0; /* Disembunyikan sepenuhnya */
      z-index: 1;
      pointer-events: none; /* Mencegah interaksi */
    }
    
    /* Canvas ditampilkan dengan efek mirror */
    canvas { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh; 
      object-fit: cover; 
      opacity: 0.7; /* Hanya canvas yang ditampilkan */
      z-index: 1;
    }
    
    /* Konten overlay */
    .konten {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100vh;
      padding: 40px 20px;
      box-sizing: border-box;
    }
    
    /* Area poin di atas */
    .score-container {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      z-index: 15;
    }
    
    #score {
      font-size: 1.5em;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      border: 2px solid #e74c3c;
      display: inline-block;
    }
    
    /* Area soal */
    #soal { 
      font-size: 1.4em; 
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.7);
      padding: 20px 40px;
      border-radius: 15px;
      border: 3px solid #e74c3c;
      max-width: 70%;
      box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
    }
    
    /* Area jawaban */
    #jawaban { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 30px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }
    
    /* Kotak jawaban */
    .kotak { 
      width: 200px; 
      height: 200px; 
      font-size: 1.2em; 
      border: 5px solid #3498db; 
      border-radius: 15px;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.7);
      cursor: pointer;
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
      word-wrap: break-word;
      overflow-wrap: break-word;
      padding: 15px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.3;
    }
    
    .kotak:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px rgba(52, 152, 219, 0.7);
    }
    
    .kotak.terpilih { 
      border-color: #2ecc71; 
      transform: scale(1.15);
      box-shadow: 0 0 30px rgba(46, 204, 113, 0.8);
      background: rgba(0, 0, 0, 0.8);
    }
    
    /* Area pesan */
    .pesan-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 30px;
      border-radius: 10px;
      border: 2px solid #e74c3c;
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 800px;
      margin: 0 auto;
    }
    
    #pesan {
      font-size: 1.2em;
      color: #2ecc71;
      min-height: 40px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* Progress bar */
    .progress-container {
      width: 80%;
      max-width: 800px;
      height: 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      margin: 10px auto;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: #2ecc71;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Gambar jantung */
    .jantung-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 3em;
      color: #e74c3c;
      animation: heartbeat 1.5s infinite;
    }
    
    @keyframes heartbeat {
      0% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1); }
      75% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Tombol */
    .tombol-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    
    .tombol {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 15px 30px;
      font-size: 1.2em;
      font-family: 'Comic Sans MS', 'Arial', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .tombol:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }
    
    .tombol:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .tombol.refresh {
      background: #e74c3c;
    }
    
    .tombol.refresh:hover {
      background: #c0392b;
    }
    
    /* Layar awal */
    .layar-awal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    
    .layar-awal h1 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #e74c3c;
    }
    
    .layar-awal p {
      font-size: 1.3em;
      max-width: 600px;
      margin-bottom: 40px;
      line-height: 1.5;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Video disembunyikan -->
  <video id="video" autoplay muted playsinline></video>
  
  <!-- Canvas ditampilkan -->
  <canvas id="canvas"></canvas>
  
  <!-- Konten overlay -->
  <div class="konten">
    <!-- Ikon jantung -->
    <div class="jantung-icon">‚ù§Ô∏è</div>
    
    <!-- Area poin di atas -->
    <div class="score-container">
      <div id="score">Poin: 0</div>
    </div>
    
    <!-- Tombol refresh -->
    <div class="tombol-container">
      <button class="tombol refresh" id="refresh-btn">üîÑ Refresh</button>
    </div>
    
    <!-- Area soal -->
    <div id="soal">Darah yang kaya oksigen dipompa oleh jantung ke seluruh tubuh melalui...?</div>
    
    <!-- Progress bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <!-- Area jawaban -->
    <div id="jawaban">
      <div class="kotak" data-pilihan="kiri">Peredaran darah besar</div>
      <div class="kotak" data-pilihan="kanan">Peredaran darah kecil</div>
    </div>
    
    <!-- Panel pesan -->
    <div class="pesan-container">
      <div id="pesan"></div>
    </div>
  </div>
  
  <!-- Layar awal -->
  <div class="layar-awal" id="layar-awal">
    <h1>Kuis Geleng Kepala</h1>
    <p>Jawablah 10 soal tentang peredaran darah dengan cara menggelengkan kepala ke kiri atau kanan. Siap untuk memulai?</p>
    <button class="tombol" id="mulai-btn">Mulai Kuis</button>
  </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>

  <script>
    const video   = document.getElementById('video');
    const canvas  = document.getElementById('canvas');
    const ctx     = canvas.getContext('2d');
    const kotak   = Array.from(document.querySelectorAll('.kotak'));
    const scoreEl = document.getElementById('score');
    const pesanEl = document.getElementById('pesan');
    const progressBar = document.getElementById('progress-bar');
    const mulaiBtn = document.getElementById('mulai-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const layarAwal = document.getElementById('layar-awal');
    
    // Set ukuran canvas sama dengan viewport
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let lastK = 0;           // untuk debounce
    let noseHistory = [];    // buffer posisi hidung
    const BUF = 5;           // jumlah frame rata-rata
    let score = 0;           // skor awal
    let sudahJawab = false;  // mencegah jawaban ganda
    let currentQuestionIndex = 0; // indeks soal saat ini
    let kuisDimulai = false; // status kuis

    // Data soal tentang peredaran darah
    const soalData = [
      {
        soal: "Darah yang kaya oksigen dipompa oleh jantung ke seluruh tubuh melalui...?",
        jawabanBenar: "Peredaran darah besar",
        pilihan: ["Peredaran darah besar", "Peredaran darah kecil"]
      },
      {
        soal: "Bagian jantung yang menerima darah dari paru-paru adalah...?",
        jawabanBenar: "Serambi kiri",
        pilihan: ["Serambi kiri", "Serambi kanan"]
      },
      {
        soal: "Bagian jantung yang memompa darah ke paru-paru adalah...?",
        jawabanBenar: "Bilik kanan",
        pilihan: ["Bilik kanan", "Bilik kiri"]
      },
      {
        soal: "Fungsi paru-paru dalam peredaran darah adalah...?",
        jawabanBenar: "Pertukaran oksigen dan karbon dioksida",
        pilihan: ["Pertukaran oksigen dan karbon dioksida", "Memompa darah ke seluruh tubuh"]
      },
      {
        soal: "Tempat terjadinya pertukaran gas di paru-paru adalah...?",
        jawabanBenar: "Alveolus",
        pilihan: ["Alveolus", "Bronkus"]
      },
      {
        soal: "Darah yang kaya karbon dioksida dari tubuh kembali ke jantung bagian...?",
        jawabanBenar: "Serambi kanan",
        pilihan: ["Serambi kanan", "Serambi kiri"]
      },
      {
        soal: "Peredaran darah kecil mengalirkan darah antara...?",
        jawabanBenar: "Jantung dan paru-paru",
        pilihan: ["Jantung dan paru-paru", "Jantung dan seluruh tubuh"]
      },
      {
        soal: "Bagian jantung yang paling kuat memompa darah adalah...?",
        jawabanBenar: "Bilik kiri",
        pilihan: ["Bilik kiri", "Bilik kanan"]
      },
      {
        soal: "Katup jantung berfungsi untuk...?",
        jawabanBenar: "Mencegah darah mengalir mundur",
        pilihan: ["Mencegah darah mengalir mundur", "Meningkatkan tekanan darah"]
      },
      {
        soal: "Darah yang sudah kaya oksigen dari paru-paru masuk ke jantung bagian...?",
        jawabanBenar: "Serambi kiri",
        pilihan: ["Serambi kiri", "Bilik kiri"]
      }
    ];

    // (1) Akses kamera
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false})
      .then(strm=>{ video.srcObject=strm; })
      .catch(err=>{ alert('Kamera diblokir atau tidak tersedia'); console.error(err)});

    // (2) Siapkan FaceMesh
    const faceMesh = new FaceMesh({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`
    });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: false,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    faceMesh.onResults(onResults);

    // (3) Mulai pipeline
    const camera = new Camera(video, {
      onFrame: async () => {
        // Gambar video ke canvas dengan efek mirror
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();
        
        await faceMesh.send({image: video});
      },
      width: 1280,
      height: 720
    });
    camera.start();

    // Event listener untuk tombol
    mulaiBtn.addEventListener('click', mulaiKuis);
    refreshBtn.addEventListener('click', refreshKuis);

    // Fungsi untuk memulai kuis
    function mulaiKuis() {
      kuisDimulai = true;
      layarAwal.classList.add('hidden');
      resetKuis();
    }

    // Fungsi untuk refresh kuis
    function refreshKuis() {
      resetKuis();
    }

    // Fungsi untuk reset kuis
    function resetKuis() {
      score = 0;
      currentQuestionIndex = 0;
      sudahJawab = false;
      scoreEl.textContent = `Poin: ${score}`;
      pesanEl.textContent = "";
      progressBar.style.width = "0%";
      
      // Reset tampilan
      kotak.forEach(k => k.classList.remove('terpilih'));
      document.getElementById('jawaban').style.display = "flex";
      document.querySelector('.progress-container').style.display = "block";
      
      // Tampilkan soal pertama
      const firstSoal = soalData[0];
      document.getElementById('soal').textContent = firstSoal.soal;
      kotak[0].textContent = firstSoal.pilihan[0];
      kotak[1].textContent = firstSoal.pilihan[1];
    }

    // (4) Callback setiap frame
    function onResults(results) {
      if (!kuisDimulai) return; // Jangan proses jika kuis belum dimulai
      
      if (!results.multiFaceLandmarks.length) return;

      const key = results.multiFaceLandmarks[0];
      const hidung = key[1];               // landmark nomor 1 = ujung hidung
      
      // Perbaiki: Balik koordinat x untuk mencerminkan gerakan yang benar
      const x = canvas.width - (hidung.x * canvas.width);

      noseHistory.push(x);
      if (noseHistory.length > BUF) noseHistory.shift();

      if (noseHistory.length < BUF) return;

      // rata-rata 5 frame
      const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      const mid = avg(noseHistory);

      // threshold sederhana
      const threshold = canvas.width * 0.15; // 15% dari lebar layar
      const kiri  = mid < canvas.width/2 - threshold;
      const kanan = mid > canvas.width/2 + threshold;

      const now = performance.now();
      if (now - lastK < 1500) return; // debounce 1.5s
      
      if (sudahJawab) return; // cegah jawaban ganda
      
      if (kiri)  { 
        pilih('kiri');  
        lastK = now; 
      } else if (kanan) { 
        pilih('kanan'); 
        lastK = now; 
      }
    }

    function pilih(arah) {
      // Tandai sudah menjawab
      sudahJawab = true;
      
      // Tandai kotak yang dipilih
      kotak.forEach(k => k.classList.toggle('terpilih', k.dataset.pilihan === arah));
      
      // Dapatkan soal saat ini
      const currentSoal = soalData[currentQuestionIndex];
      
      // Tentukan jawaban user
      const jawabanUser = arah === 'kiri' ? currentSoal.pilihan[0] : currentSoal.pilihan[1];
      
      // Cek kebenaran
      if (jawabanUser === currentSoal.jawabanBenar) {
        score += 10;
        pesanEl.textContent = "Benar! +10 Poin";
        pesanEl.style.color = "#2ecc71";
      } else {
        pesanEl.textContent = "Salah! Jawaban: " + currentSoal.jawabanBenar;
        pesanEl.style.color = "#e74c3c";
      }
      
      // Update skor
      scoreEl.textContent = `Poin: ${score}`;
      
      // Update progress bar
      const progress = ((currentQuestionIndex + 1) / soalData.length) * 100;
      progressBar.style.width = progress + "%";
      
      // Reset untuk soal berikutnya (setelah 3 detik)
      setTimeout(() => {
        // Reset tampilan
        kotak.forEach(k => k.classList.remove('terpilih'));
        pesanEl.textContent = "";
        
        // Reset status
        sudahJawab = false;
        
        // Pindah ke soal berikutnya
        currentQuestionIndex++;
        
        // Cek apakah sudah selesai semua soal
        if (currentQuestionIndex >= soalData.length) {
          // Tampilkan hasil akhir
          document.getElementById('soal').textContent = "Kuis Selesai! Skor Akhir: " + score + "/" + (soalData.length * 10);
          document.getElementById('jawaban').style.display = "none";
          document.querySelector('.progress-container').style.display = "none";
          
          // Tampilkan pesan berdasarkan skor
          if (score >= 80) {
            pesanEl.textContent = "Hebat! Kamu ahli peredaran darah!";
            pesanEl.style.color = "#2ecc71";
          } else if (score >= 50) {
            pesanEl.textContent = "Bagus! Tapi bisa lebih baik lagi!";
            pesanEl.style.color = "#f39c12";
          } else {
            pesanEl.textContent = "Belajar lagi ya tentang peredaran darah!";
            pesanEl.style.color = "#e74c3c";
          }
        } else {
          // Update soal dan pilihan
          const nextSoal = soalData[currentQuestionIndex];
          document.getElementById('soal').textContent = nextSoal.soal;
          kotak[0].textContent = nextSoal.pilihan[0];
          kotak[1].textContent = nextSoal.pilihan[1];
        }
      }, 3000);
    }
  </script>
</body>
</html>
